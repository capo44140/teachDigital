name: ðŸš€ Deploy to Synology

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permet de dÃ©clencher manuellement

jobs:
  deploy:
    name: ðŸ“¦ Build & Deploy to Synology
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SYNOLOGY_SSH_KEY }}

      - name: ðŸ” Add Synology to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SYNOLOGY_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Deploy to Synology
        env:
          SYNOLOGY_HOST: ${{ secrets.SYNOLOGY_HOST }}
          SYNOLOGY_USER: ${{ secrets.SYNOLOGY_USER }}
          SYNOLOGY_PATH: ${{ secrets.SYNOLOGY_DEPLOY_PATH }}
        run: |
          echo "ðŸš€ DÃ©ploiement sur Synology..."
          
          # CrÃ©er le rÃ©pertoire de dÃ©ploiement s'il n'existe pas
          ssh ${{ secrets.SYNOLOGY_USER }}@${{ secrets.SYNOLOGY_HOST }} \
            "mkdir -p ${{ secrets.SYNOLOGY_DEPLOY_PATH }}"
          
          # Copier les fichiers nÃ©cessaires
          echo "ðŸ“‹ Copie des fichiers..."
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'dist' \
            --exclude '.env' \
            --exclude '*.log' \
            -e ssh \
            ./ ${{ secrets.SYNOLOGY_USER }}@${{ secrets.SYNOLOGY_HOST }}:${{ secrets.SYNOLOGY_DEPLOY_PATH }}/
          
          # ExÃ©cuter le dÃ©ploiement sur le Synology
          echo "ðŸ”§ DÃ©ploiement des conteneurs Docker..."
          ssh ${{ secrets.SYNOLOGY_USER }}@${{ secrets.SYNOLOGY_HOST }} << 'ENDSSH'
            cd ${{ secrets.SYNOLOGY_DEPLOY_PATH }}
            
            # ArrÃªter les conteneurs existants
            echo "â¸ï¸ ArrÃªt des conteneurs..."
            docker-compose down || true
            
            # Pull les derniÃ¨res images (si nÃ©cessaire)
            echo "ðŸ“¥ Pull des images Docker..."
            docker-compose pull || true
            
            # Build les images (si Dockerfile existe)
            echo "ðŸ”¨ Build des images..."
            docker-compose build --no-cache || true
            
            # DÃ©marrer les conteneurs
            echo "â–¶ï¸ DÃ©marrage des conteneurs..."
            docker-compose up -d
            
            # Attendre que les services soient prÃªts
            echo "â³ Attente du dÃ©marrage des services..."
            sleep 10
            
            # VÃ©rifier l'Ã©tat des conteneurs
            echo "âœ… Ã‰tat des conteneurs:"
            docker-compose ps
            
            # Afficher les logs rÃ©cents
            echo "ðŸ“‹ Logs rÃ©cents:"
            docker-compose logs --tail=50
          ENDSSH
          
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s!"

      - name: ðŸ§ª Health Check
        env:
          SYNOLOGY_HOST: ${{ secrets.SYNOLOGY_HOST }}
          SYNOLOGY_USER: ${{ secrets.SYNOLOGY_USER }}
        run: |
          echo "ðŸ¥ VÃ©rification de santÃ© des services..."
          ssh ${{ secrets.SYNOLOGY_USER }}@${{ secrets.SYNOLOGY_HOST }} << 'ENDSSH'
            cd ${{ secrets.SYNOLOGY_DEPLOY_PATH }}
            
            # VÃ©rifier que les conteneurs sont en cours d'exÃ©cution
            if docker-compose ps | grep -q "Up"; then
              echo "âœ… Les conteneurs sont en cours d'exÃ©cution"
            else
              echo "âŒ Certains conteneurs ne sont pas dÃ©marrÃ©s"
              docker-compose ps
              exit 1
            fi
            
            # Test de connexion Ã  la base de donnÃ©es
            echo "ðŸ” Test de connexion Ã  la base de donnÃ©es..."
            docker-compose exec -T db psql -U postgres -c "SELECT 1" || echo "âš ï¸ Base de donnÃ©es non accessible"
          ENDSSH

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ RÃ©sumÃ© du dÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… DÃ©ploiement terminÃ© sur Synology" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branche:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Auteur:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

